# Route 53

## DNS 란?

- Domain Name System
- 호스트 이름, url 을 대상 서버 **IP 주소로 번역**
- 계층적 이름 구조를 가지고 있다

### DNS Terminologies : 관련 용어

- Domain Registrar : 도메인 이름을 등록하는 곳 (→ route 53)
- DNS Recoreds :
- Zone file : DNS 레코드를 포함. 호스트 이름과 IP, 주소를 일치시키는 방법
- Name Server : DNS 쿼리를 실제로 해결하는 서버
- Top Level Domain(TLD) : com, us, in, gov, org
- Second Level Domain(SLD) : amazon.com, google.com
- Root (마지막 점) → TLD → SLD → Sub Domain → Domain Name → Protocol

### DNS 동작 방법

- 공인 IP 가 하나 있을 때, 도메인 이름으로 접근을 시도
    - 원하는 도메인 이름을 가지고 DNS 서버를 등록해야 한다
1. 사용자가 웹 브라우저에 도메인 이름을 가지고 접근을 시도
2. Local DNS Server에 도메인 이름을 검색
3. Local Server가 이 쿼리를 본적이 없다면, **(ICANN에 의해 관리되는 )DNS 서버의 루트**에 검색
    1. 루트 DNS 서버는 TLD부터 검색 → 만약 (예시)com을 안다면 해당 이름 서버 레코드를 알려줌
    2. **(IANA에 의해 관리되는 )TLD DNS Server**(예 : com 도메인 서버)에게 쿼리의 답을 요청
4. 해당 서버를 알고 있다면 ip를 전달
5. 최종, 서브 도메인(SLD) DNS 서버는 해당 주소 항목을 결과로 보냄
6. 차례로 물어본 결과로 웹 서버를 얻을 수 있고, 앞으로 다시 같은 주소를 물어본다면 바로 답변 가능

<br>

# Amazon Route 53

- 고가용성, 확장성을 가진, 완전히 관리되며 권한있는 DNS
    - 권한이 있다 →사용자가 DNS 레코드를 업데이트 할 수 있다
- 도메인 레지스트라 → 도메인 이름을 등록 가능
- 리소스 관련 상태 확인 가능
- 100% SLA 가용성을 제공하는 유일한 AWS 서비스
- 53란 ? DNS 서비스, 이름에서 사용되는 전통적인 DNS 포트

<br>

### Route 53 - Records

- Route 53에서 여러 DNS 레코드를 정의하고 레코드를 통해 특정 도메인으로 라우팅하는 방법 정의
- 각 레코드는 도메인, 서브 도메인 이름 정보를 포함
- **레코드 종류 : A, AAAA, CNAME, NS**
- 레코드의 값 : 123.456.789.123
- 라우팅 정책 : route 53이 쿼리에 응답하는 방식
- TTL : DNS가 resolver에서 레코드가 캐싱되는 시간

<br>


### Route 53 - Record Types

- A : IPv4와 호스트 이름을 매핑
- AAAA : IPv6와 호스트 이름을 매핑
- CNAME : 호스트 이름을 다른 호스트 이름과 매핑
    - 대상 호스트 이름은 A, AAAA에 포함된 호스트 이름일지도..
    - DNS 이름공간 또는 Zone Apex의 상위 노드에 대한 CNAMES를 생성할 수 없다
- NS : 호스팅 존의 이름 서버, 서버의 DNS 이름 또는 IP 주소로 호스팅 존에 대한 DNS 쿼리에 응답 가능. 트래픽이 도메인으로 라우팅 되는 방식을 제어

<br>


### Route 53 - Hosted Zones

- 레코드의 컨테이너
- 도메인과 서브도메인으로 가는 트래픽의 라우팅 방식 정의
- 호스팅 존
    - 퍼블릭 호스팅 존
        - 인터넷에서 라우팅이 트래픽되는 법을 구분하는 레코드를 포함
        - 이름을 살때마다 퍼블릭 호스팅 존을 만들 수 있다
        - 쿼리에 도메인 이름의 IP가 무엇인지 알 수 있다
    - 프라이빗 호스팅 존
        - VPC 내부에서만 라우팅이 트래픽되는지를 구분하는 레코드 포함
        - 공개되지 않는 도메인 이름을 지원
        - 가상 프라이빗 클라우드 (VPC) 만이 url을 리졸브 할 수 있다
    - 각 호스트 존마다 월 $0.50 을 지불해야 한다

<br>

### Public vs Private Hosted Zones

public 

- 공개된 클라이언트로부터 온 쿼리에 응답 가능

private

- 해당 VPC에서만 동작
- 비공개 도메인 이름의 프라이빗 리소스를 식별 가능

<br>

### Route 53 - Records TTL (Time To Live)

- 최초 : 클라이언트가 DNS route 53과 웹 서버에 접속 → DNS로부터 회신
- 회신 내용 : A 레코드 & IP 주소 & TTL
- TTL 시간동안 클라이언트는 결과를 캐시 (TTL 시간동안 재요청을 보내거나 DNS에게 쿼리를 보낼 필요가 없다)
- 이미 저장된 답변을 이용함으로써 웹 서버에 접속이 가능한 HTTP 요청 및 회신을 보낼 수 있음
- TTL 설정
    - TTL 시간을 늘림
        - 트래픽이 적고, 요청을 적게 보냄
        - 클라이언트가 오래된 레코드를 받을 가능성이 있음
    - TTL 시간을 줄임
        - DNS 서버 트래픽 양이 많아져서 비용이 많이 듦
            - Route 53에 들어오는 요청의 양에 따라 요금 책정
        - 오래된 레코드 보관 시간은 짧아짐
<br>

---

<br>

## CNAME 과 별칭의 차이

- 로드밸런서나, 클라우드 프론트 등 AWS의 리소스를 사용하면 AWS 호스트 이름이 노출되는데, **보유한 도메인에 호스트 이름을 매핑하고자 할 경우의 선택지**
1. CNAME
    - 호스트 이름이 다른 호스트 이름으로 향하도록 할 수 있다
    - 루트 도메인 이름이 아닌 경우에만 가능 (서브 이상 도메인이 있어야함)
    - 
2. Alias 
    - Route 53에 한정되지만 호스트 이름이 특정 AWS 리소스로 향하도록 할 수 있음
    - 루트 및 비루트 도메인 모두 작동 가능
    - 무료
    - 자체적으로 상태 확인이 가능
    - 리소스의 IP 주소가 바뀌는 것을 자동 인식
    - CNAME과 달리 탑 노드의 DNS 네임스페이스 (Zone Apex)에 사용될 수 있다
    - AWS 리소스를 위한 별칭 레코드의 타입 → A, AAAA (IPv4, IPv6)
    - 별칭 설정 시 TTL 사용 불가 ( Route 53에 의해 자동 설정)
    - 대상 : ELB, CloudFront 배포, API Gateway, 엘라스틱 빈스톡 환경, S3 웹사이트 (버킷 X), VPC 인터페이스 엔드포인트, Global Accelerator, 동일 호스트 존의 Route 53
    - **EC2 DNS 이름은 별칭 레코드의 대상이 될 수 없다**



<br>

### Route 53 - Routing 정책

- 라우팅 정책은 Route 53이 DNS 쿼리에 응답하는 것을 도움
- 라우팅 : DNS 관점에서 DNS 쿼리에만 응답하게 되고 클라이언트들은 이를 통해 HTTP 쿼리등을 어떻게 처리해야 하는지 알 수 있게 함
- DNS : 호스트 이름들을 클라이언트가 실제 사용 가능한 엔드 포인트로 변환하는 것을 도움
- Route 53이 지원하는 라우팅 정책
    - Simple 단순
    - Weighted 가중치 기반
    - Failover 장애 조치
    - Latency based 지연 시간 기반
    - Geolocation 지리적
    - Multi-value answer 다중 값 응답
    - Geoproximity (using Route 53 Traffic Flow feature) 지리 근접 라우팅 정책

---

<br>


**Simple : 단순 라우팅 정책**

- 기존에 우리가 사용해온 방식
- 일반적으로 트래픽을 단일 리소스로 보내는 방식
- A 레코드에 임베딩된 주소 (동일한 레코드에 여러 개의 값을 지정하는 것도 가능)
- DNS에 의해 다중 값의 받은 경우, 클라이언트 쪽에서 그 중 하나를 무작위로 고름
- 단순 라우팅 정책에 별칭 레코드를 함께 사용하면 하나의 AWS 리소스만을 대상으로 지정할 수 있다
- 상태  확인이 불가능

<br>

**Weighted : 가중치 기반 라우팅 정책**

- 가중치를 활용해 요청의 일부 비율을 특정 리소스로 보내는 식의 제어가 가능
- Route 53에서 오는 DNS 응답의 특정 비율이 특정 EC2 인스턴스로 리다이렉팅
- 각 레코드로 보내지는 트래픽의 양은 해당 레코드의 가중치를 전체 가중치로 나눈 값
- 합이 100이 아니어도 된다
- 정책이 사용되는 경우
    - 서로 다른 지역에 걸쳐 로드 밸런싱을 할 때
    - 적은 양의 트래픽을 보내 새 애플리케이션을 테스트 하는 경우
- 가중치 0의 값을 보내게 되면 특정 리소스에 트래픽 보내기를 중단 → 가중치를 바꿀 수 있다
- 모든 리소스 레코드 가중치의 값이 0인 경우에는 모든 레코드가 다시 동일한 가중치를 갖게 된다

<br>

**Latency : 지연 시간 기반 라우팅 정책**

- 지연 시간이 가장 짧은, 가장 가까운 리소스로 리다이렉팅하는 정책 → 지연 시간에 민감한 웹사이트나 애플리케이션이 있는 경우 유용
- 지연 시간 측정 방법 : 유저가 레코드로 가장 가까운 식별된 AWS 리전에 연결하기까지 걸리는 시간을 기반으로 측정
- 상태 확인과 연결 가능
- Route 53이 지연 시간을 측정한 뒤 지연시간이 가장 짧은 가까운 거리의 유저들이 먼저 닿은 ALB(Application Load Balancer)로 연결되고 나머지 유저들이 다른 리소스로 연결

<br>

**Health Checks : 상태 확인**

- 개인 리소스 상태를 확인하는 방법
- 상태 확인을 Route 53의 레코드와 연결 가능
    - DNS의 장애 조치를 자동화하기 위한 작업

<br>

**상태 확인 방법 → 공용 엔드 포인트를 모니터링**

- 대상 : 애플리케이션, 서버, 다른 AWS 리소스
- 이 두 상태 확인은 각자의 메트릭을 사용하는데, CloudWatch의 지표에서도 확인이 가능
- HTTP, HTTPS, TCP 등 많은 프로토콜을 지원
- 18% 이상의 상태 확인이 엔드 포인트를 정상이라고 판단하면 Route 53도 이를 정상으로 간주 (그 이하면 비정상으로 인식)
- 상태 확인은 로드밸런서로부터 2**나 3**의 코드를 받아야만 통과
- 텍스트 기반 응답일 경우, 처음 5120바이트 확인 (응답 자체에 해당 텍스트가 있는지 확인)
- 네트워크 관점일 때 상태 확인의 작동이 가능하려면, 상태 확인이 애플리케이션 밸런서나 엔드 포인트에 접근이 가능해야 함

<br>

**상태 확인 방법 → 계산된 상태 확인** 

- 대상 : CloudWatch 경보의 상태를 모니터링하는 상태 확인
- Route 53의 상태 확인 IP 주소 범위에서 들어오는 모든 요청을 허용해야 함
- 계산된 상태 확인은 여러 개의 상태 확인 결과를 하나로 합쳐주는 기능 → 상위/하위 상태 확인
- 상태 확인들을 모두 합치기 위한 조건 [OR, AND, NOT]
- 하위 상태 확인은 256개까지 모니터링 가능
- 상위 상태 확인이 통과하기 위해 몇 개의 상태 확인을 통과해야 하는지 지정 가능 → 상태 확인이 실패하는 일 없이 상위 상태 확인이 웹사이트를 관리 유지하도록 하는 경우

<br>

**상태 확인 방법 → 개인의 리소스 상태 확인**

- 모든 Route 53의 상태 확인이 **공용 웹에** 있기 때문에 주로 **VPC 외부**에 있기 마련
- VPC 내부에 있는 개인 엔드포인트, 온프레미스 리소스인 경우 접근 불가능 → CloudWatch 지표를 만들어 CloudWatch 알람을 할당하는 식으로 문제 해결 가능
    - CloudWatch 메트릭을 이용해 개인 서브넷 안에 있는 EC2 인스턴스를 모니터
    - 메트릭이 침해되는 경우 CloudWatch 알람을 생성
    - 알람이 울리면 상태확인은 자동으로 비정상 처리


<br>

**Failover (Active-Passive) : 장애 조치 라우팅 정책**

- 기본 EC2 인스턴스와 보조(재해 복구) EC2 인스턴스를 두고, 상태확인과 기본 레코드 연결이 필수적
    - 상태 확인이 비정상이면 자동으로 Route 53은 2번째의 EC2 인스턴스로 장애 조치하며 결과를 보내기 시작
- 보조 인스턴스 역시 상태 확인을 연결할 수 있으나, 기본과 보조가 각각 하나씩만 있을 수 있다
- 클라이언트의 DNS 요청은 정상으로 생각되는 리소스를 자동으로 얻는다
    - 기본 인스턴스가 정상 → Route 53도 기본 레코드로 응답
    - 상태 확인이 비정상 → 장애 조치에 도움이 되는 보조 레코드의 응답을 자동으로 얻게 됨

<br>


**Geolocation : 지리 위치 라우팅 정책**

- 사용자의 실제 위치 기반
- 특정 대륙의 국가에 어떤 도시까지 지정하여 가장 정확한 위치를 선택해 그 IP로 라우팅
- 일치하는 위치가 없는 경우는 기본 레코드를 생성
- 사용 사례 : 콘텐츠 분산을 제한하고 로드밸런싱을 실행하는 웹사이트 현지화
    - 한국에 있는 유저가 한국어 버전 앱을 포함한 IP로 접속되도록 지리 레코드를 정의할 수 있다
    - 그 외 다른 곳은 앱에서 영어 버전이 포함된 기본 IP로 이동

<br>


**Geoproximity : 지리 근접 라우팅 정책**

- 사용자와 리소스의 지리적 위치를 기반으로 트래픽을 리소스로 라우팅 유도
- 편향값을 사용해 특정 위치를 기반으로 리소스에 더 많은 트래픽을 보냄
- 지리적 위치를 변경하려면 편향값을 지정해야 함
    - 특정 리소스의 편향값을 증가? → 더 많은 트래픽
    - 리소스에 트래픽을 줄이기 위해 → 편향값을 음수로 축소
- 리소스 별 파악 방법
    - AWS 리소스 : 속한 특정 리전을 지정하면 목록에서 자동으로 올바른 라우팅을 계산
    - AWS 리소스가 아닌 온프레미스 데이터 센터 : 위도와 경도를 지정해 AWS가 위치를 파악하도록 함
- 이 라우팅 정책을 사용하기 위해서는 고급  Route 53 트래픽 플로우를 무조건 사용해야함

<br>


**Traffic flow : 트래픽 플로우**

- 복잡한 지리 근접 레코드 등 복잡한 라우팅 의사 결정 트리를 관리하고 설계하는 방법
- Route 53에 있는 DNS 관리 시스템에 하나씩 기록하는 대신 모두 시각적으로 관리
- 장점
    - 트래픽 플로우 정책으로 저장됨
    - 버전을 지정하고 호스팅 영역을 적용할 수 있다
    - 호스팅 영역에서 쉽게 변경하고 적용할 수 있다


<br>


**Multi-Value : 다중 값 라우팅 정책**

- 트래픽을 다중 리소스로 라우팅할 때 사용
- Route 53은 다중 값과 리소스를 반환
- 상태 확인과 연결하면 다중값 정책에서 반환되는 유일한 리소스는 “리소스의 정상 값”
- 각각의 다중 값 쿼리에 최대 8개의 정상 레코드가 반환
- ELB 대체가 아님. 클라이언트 측면의 로드 밸런싱
    - 클라이언트에서 다중 값 쿼리를 실행하면 최대 8개의 레코드를 수신하게 되고 클라이언트는 하나를 선택
    - 최소한 상태 확인과 결합하면 반환되는 8개의 레코드 중 1 ~ 8개의 레코드가 정상 → 클라이언트가 안전한 쿼리를 요청
- 단, 다중 값이 있는 라우팅 경우 단순 라우팅 정책은 상태확인을 허용하지 않는다
    - 단순 라우팅 정책의 쿼리가 반환하는 리소스 중 하나는 비정상일 가능성 O

<br>


**Traffic flow : 트래픽 플로우**

- 복잡한 지리 근접 레코드 등 복잡한 라우팅 의사 결정 트리를 관리하고 설계하는 방법
- Route 53에 있는 DNS 관리 시스템에 하나씩 기록하는 대신 모두 시각적으로 관리 → **UI 제공**
- 장점
    - 트래픽 플로우 정책으로 저장됨
    - 버전을 지정하고 호스팅 영역을 적용할 수 있다
    - 호스팅 영역에서 쉽게 변경하고 적용할 수 있다

<br>


### Domain Registar vs DNS Service

- 도메인 이름 레지스트라를 통해 원하는 도메인 이름을 구매 가능 (연간 지불)
- Route 53 콘솔을 통한 Amazon Registar를 사용해도 되지만, 다른 도메인 이름 레지스트라를 이용해도 상관없다
- 보통 레지스트라를 통해 도메인을 등록하면 DNS 레코드 관리를 위한 DNS 서비스를 제공 → Amazon에서 DNS 이름을 등록하면 그 레코드 관리를 위한 Route 53 호스팅 존을 가지게 된다
- Amazon 레지스트라가 아닐 경우, 도메인을 등록하면 “이름 서버 옵션”이 생겨서 사용자 정의 이름 서버를 지정 가능
    - Amazon Route 53에서 원하는 도메인의 **공용 호스팅 영역** 생성
    - 호스팅 영역 상세에서 이름 서버 검색
    - 이름 서버에 관한 쿼리에 응답하면 이름 서버가 Amazon Route 53 이름 서버를 가리키고 Route 53 콘솔에서 전체 관리 가능