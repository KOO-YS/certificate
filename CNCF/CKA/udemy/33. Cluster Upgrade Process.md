# Cluster Upgrade Process


Kubernetes 컴포넌트들의 버전이 모두 일치할 필요는 없다

- `X` : kube-apiserver 
    - 컨트롤 플레인 컴포넌트 중 가장 메인이 되는 컴포넌트
    - 어떤 컴포넌트도 kube-apiserver보다 상위 버전을 사용할 수 없다

- `X-1` : Controller-manager, kube-scheduler
    - kube-apiserver 대비 한 단계 하위 버전까지 사용할 수 있다 

- `X-2` : kubelet, kube-proxy
    - kube-apiserver 대비 두 단계 하위 버전까지 사용할 수 있다

- `X+1 ~ X-1` : kubectl 
    - 오직 kubectl만이 kube-apiserver보다 상위 버전을 사용할 수 있다

### 업그레이드가 필요한 상황
- Kubernetes는 최근 3 마이너 버전까지 지원한다

### 권장하는 업그레이드 방법
- 한 마이너 버전씩 차례로 업그레이드하는 방법을 권고
    - [ex] 1.10 -> 1.11 / 1.11 -> 1.12 / 1.12 -> 1.13

### 업그레이드 방법 -> 클러스터 설치방법에 따름
- Managed Kubernetes Cluster
    - 클라우드 서비스 제공사에 따라 몇 번의 클릭만으로 업그레이드 가능
- kubeadm
    - 툴이 클러스터 업그레이드를 계획하고 적용할 수 있다
    
    ```shell
    kubeadm upgrade plan
    kubeadm upgrade apply
    ```
- 수작업 설치
    - 직접 개별 컴포넌트를 업그레이드 해줘야한다..

### 업그레이드 절차
1. master node를 먼저 업그레이드한 후, worker node를 업그레이드 한다
    - master node가 업그레이드 되고 있는 동안 control plane 컴포넌트들은 잠시 종료된다
    - 모든 관리 기능들이 사용 중지된다
    - master node가 종료되었다고 worker node와 그 안의 애플리케이션들이 사용불가가 되진 않는다 -> 평소대로 운영된다
2. master node가 업그레이드를 마치면, worker node의 업그레이드 차례
   worker node의 업그레이드 전략은 총 3가지가 있다
    2-1. 모든 애플리케이션을 한 번에 업그레이드 하는 방법
    - 업그레이드 되는 동안 애플리케이션에 접근이 불가능하므로 downtime이 요구된다
    2-2. 한 번에 한 node씩 업그레이드 하는 방법
    - 지정 노드의 애플리케이션들을 다른 노드들로 옮겨서 업그레이드 할 동안 지장이 없게 한다
    2-3. 업그레이드 된 새 node를 클러스터에 추가하는 방법
    - 클라우드 환경에서 편리한 방법
    - 만들어진 새 node에 애플리케이션들을 옮기고 기존 노드를 삭제한다
    








