# Backup And Restore

#### 백업의 대상
- Resource Configuration : deployment, pod, service 정의 파일을 이용해 배포된 애플리케이션들
- Persistance : 애플리케이션 설정 저장소
- ETCD Cluster : 모든 클러스터 연관 정보가 담긴 etcd 클러스터

### Resource Configuration
- 가진 아이템의 개수만큼 파일을 가지고 있기 때문에 버전관리 툴을 이용해 백업을 하면 유용하다
- 만약 명령형으로 아이템을 배포하여 가진 설정파일이 없다면?
    - Kube API Server를 이용해 리소스 설정을 백업할 수 있다

    ```shell
    kubectl get all --all-namespace -o yaml > all-deploy-service.yaml
    ```
- Kubernetes 백업 툴을 사용할 수도 있다
    - Veleor(구 ark) 등

### ETCD Cluster
- 설정을 보면 `--data-dir` 경로 안에 모든 데이터가 저장되어 있다 -> 백업으로 사용
- snapshot 기능을 사용한 백업
    ```shell
    ETCDTL_API=3
    etcdctl snapshot save snapshot.db
    ```
- snapshot 복원
    - 스냅샷 복원 명령어 실행
        ```shell
        service kube-apiserver stop

        ETCDTL_API=3
        etcdctl snapshot restore snapshot.db --data-dir /var/lib/etcd-from-backup
        ```
    - etcd.service 설정파일의 `--data-dir`이 /var/lib/etcd-from-backup 맞는지 확인
    - 시스템 재시작
        ```shell
        systemctl daemon-reload

        service etcd restart 
        service kube-apiserver start
        ```

